<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suivi b√©b√©</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
    }

    .section {
      margin-bottom: 20px;
    }

    .entry {
      margin: 5px 0;
    }

    .inline {
      display: inline-block;
      margin-right: 10px;
    }

    .entry button {
      margin-left: 5px;
    }

    textarea {
      width: 100%;
      height: 80px;
    }
  </style>
</head>

<body>
  <h1>Suivi b√©b√©<br>Du <input type="date" id="date" onchange="loadDataAnotherDay()"></h1><br>


  <div class="section">
    <label>Heure de lev√©e : <input type="time" id="wake"></label><br>
  </div>

  <div class="section">
    <h3>Biberon - Total : <span id="bottle-total">0</span> ml</h3>
    <div id="bottle-list"></div>
    <button onclick="addBottle()">Ajouter un biberon</button>
  </div>

  <div class="section">
    <h3>Changements de couche</h3>
    <div id="diaper-list"></div>
    <button onclick="addDiaper()">Ajouter un change</button>
  </div>

  <div class="section">
    <h3>Siestes - Total : <span id="nap-total">0</span> heures</h3>
    <div id="nap-list"></div>
    <button onclick="addNap()">Ajouter une sieste</button>
  </div>

  <div class="section">
    <strong>Repas solides :</strong>
    <div id="meal-list"></div>
    <button onclick="addMeal()">Ajouter un repas</button>
  </div>

  <div class="section">
    <h3>Qualit√© de la journ√©e</h3>
    <label>
      <select id="dayQuality">
        <option value="">-- S√©lectionner --</option>
        <option value="1">üò£ Difficile</option>
        <option value="2">üòê Moyenne</option>
        <option value="3">üòä Bonne</option>
      </select>
    </label>
  </div>

  <div class="section">
    <h3>Commentaire</h3>
    <textarea id="comment" placeholder="Notes ou remarques..."></textarea>
  </div>

  <div class="section">
    <button onclick="generateLink()">G√©n√©rer le lien</button>
    <p><a id="generatedLink" href="#" target="_blank"></a></p>
  </div>

  <!-- <div class="section">
    <h3>R√©sum√© de la journ√©e</h3>
    <p id="day-summary"></p>
  </div> -->

  <script>
    const bottleList = document.getElementById('bottle-list');
    const diaperList = document.getElementById('diaper-list');
    const napList = document.getElementById('nap-list');
    const mealList = document.getElementById('meal-list');


    // Met √† jour le total des biberons
    function updateBottleTotal() {
      const total = Array.from(bottleList.children).reduce((sum, entry) => {
        const mlInput = entry.querySelector('input[type="number"]');
        return sum + (parseInt(mlInput.value) || 0);
      }, 0);
      document.getElementById('bottle-total').textContent = total;
    }


    // Ajoute une entr√©e pour un biberon dans la liste
    function addBottle(time = '', ml = 210) {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `<input type="time" value="${time}">
        <input type="number" min="0" step="30" value="${ml}" style="width: 60px;"> ml
        <button onclick="this.parentNode.remove()">Suppr</button>`;
      bottleList.appendChild(div);
      updateBottleTotal();
    }

    // Ajoute une entr√©e pour un changement de couche dans la liste
    function addDiaper(time = '', poop = false) {
      const container = document.createElement('div');
      container.className = 'entry';
      container.innerHTML = `
        <input type="time" value="${time}">
        <label><input type="checkbox" ${poop ? 'checked' : ''}> üí©</label>
        <button onclick="this.parentElement.remove()">Supprimer</button>`;
      diaperList.appendChild(container);
    }

    
    // Ajoute une entr√©e pour une sieste dans la liste
    function addNap(start = '', end = '') {
      const container = document.createElement('div');
      container.className = 'entry';
      container.innerHTML = `
        <input type="time" value="${start}" onchange="updateNapTotal()"> - 
        <input type="time" value="${end}" onchange="updateNapTotal()">
        <button onclick="this.parentElement.remove(); updateNapTotal()">Supprimer</button>`;
      napList.appendChild(container);
      updateNapTotal();
    }

    // Met √† jour le total des siestes
    function updateNapTotal() {
      const total = Array.from(napList.children).reduce((sum, entry) => {
        const inputs = entry.querySelectorAll('input[type="time"]');
        const start = inputs[0].value;
        const end = inputs[1].value;

        if (start && end) {
          const startTime = new Date(`1970-01-01T${start}:00`);
          const endTime = new Date(`1970-01-01T${end}:00`);
          const duration = (endTime - startTime) / (1000 * 60 * 60); // Convertir en heures
          return sum + (duration > 0 ? duration : 0); // Ajouter uniquement les dur√©es positives
        }
        return sum;
      }, 0);

      document.getElementById('nap-total').textContent = total.toFixed(2); // Afficher avec 2 d√©cimales
    }

    // Ajoute une entr√©e pour un repas solide dans la liste
    function addMeal(time = '', type = '', g = 0) {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `<input type="time" value="${time}">
        <input type="text" placeholder="Type (pur√©e...)" value="${type}">
        <input type="number" min="0" step="10" value="${g}" style="width: 60px;"> g
        <button onclick="this.parentNode.remove()">Suppr</button>`;
      mealList.appendChild(div);
    }

    // Encode les donn√©es saisies dans le formulaire en JSON, puis en base64
    function encodeData() {
      const d = document.getElementById('date').value;
      const w = document.getElementById('wake').value;
      const q = document.getElementById('dayQuality').value;
      const c = document.getElementById('comment').value;

      const bottles = Array.from(bottleList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          time: inputs[0].value,
          ml: inputs[1].value
        };
      });

      const diapers = Array.from(diaperList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          time: inputs[0].value,
          poop: inputs[1].checked
        };
      });

      const naps = Array.from(napList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          start: inputs[0].value,
          end: inputs[1].value
        };
      });

      const meals = Array.from(mealList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          time: inputs[0].value,
          type: inputs[1].value,
          weight: inputs[2].value
        };
      });

      const obj = { d, w, q, c, bottles, diapers, naps, meals };
      return btoa(JSON.stringify(obj));
    }

    // G√©n√®re un lien partageable contenant les donn√©es encod√©es
    function generateLink() {
      const hash = encodeData();
      const url = location.origin + location.pathname + '#' + hash;

      // R√©cup√®re la date du jour
      const date = document.getElementById('date').value;

      // Sauvegarde les donn√©es dans le localStorage avec la date comme cl√©
      if (date) {
        localStorage.setItem(`babyTrackData_${date}`, hash);
      }

      const link = document.getElementById('generatedLink');
      link.href = url;
      link.textContent = url;

      updateDaySummary();
    }

    // Met √† jour le r√©sum√© de la journ√©e affich√© √† l'√©cran
    function updateDaySummary() {
      const date = document.getElementById('date').value;
      const wake = document.getElementById('wake').value;
      const quality = document.getElementById('dayQuality').value;
      const qualityText = quality === '1' ? 'üò£ Difficile' : quality === '2' ? 'üòê Moyenne' : quality === '3' ? 'üòä Bonne' : 'Non d√©fini';
      const comment = document.getElementById('comment').value;

      const bottles = Array.from(bottleList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return `<strong>${inputs[0].value}</strong> : <strong>${inputs[1].value || '0'} ml</strong>`;
      });

      const diapers = Array.from(diaperList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return `<strong>${inputs[0].value}</strong>` + (inputs[1].checked ? ' <span style="color: red;">(üí©)</span>' : '');
      });

      const naps = Array.from(napList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return `<strong>${inputs[0].value}</strong> <=> <strong>${inputs[1].value || 'Non d√©finie'}</strong>`;
      });

      const meals = Array.from(mealList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return `<strong>${inputs[0].value}</strong> : <strong>${inputs[1].value || 'Non d√©finie'}</strong> - <strong>${inputs[2].value || 'Non d√©finie'}g</strong>`;
      });

      const summary = `
    <div style="font-size: 18px; line-height: 1.6;">
      <strong>Biberon :</strong><br>
      ${bottles.length > 0 ? bottles.join('<br>') : '<em>Aucun</em>'}<br><br>
      <strong>Changements de couche :</strong><br>
      ${diapers.length > 0 ? diapers.join('<br>') : '<em>Aucun</em>'}<br><br>
      <strong>Siestes :</strong><br>
      ${naps.length > 0 ? naps.join('<br>') : '<em>Aucune</em>'}<br><br>
      <strong>Repas solides :</strong><br>
      ${meals.length > 0 ? meals.join('<br>') : '<em>Aucune</em>'}
    </div>
  `;
      // document.getElementById('day-summary').innerHTML = summary;
    }

    // D√©code les donn√©es encod√©es en base64 depuis l'URL
    function decodeData() {
      if (!location.hash) return null;
      try {
        const json = atob(location.hash.slice(1));
        return JSON.parse(json);
      } catch (e) {
        console.error("Erreur de d√©codage", e);
        return null;
      }
    }

    // Charge les donn√©es depuis le localStorage ou le hash et les ins√®re dans le formulaire
    function loadData() {
      let data = null;

      // R√©cup√®re la date du jour
      const dateInput = document.getElementById('date');
      const today = dateInput.value || new Date().toISOString().split('T')[0];

      // Priorit√© 1 : Charger depuis le localStorage pour la date du jour
      const storedData = localStorage.getItem(`babyTrackData_${today}`);
      if (storedData) {
        try {
          data = JSON.parse(atob(storedData));
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du localStorage", e);
        }
      }

      // Priorit√© 2 : Charger depuis le hash si aucune donn√©e valide dans le localStorage
      if (!data && location.hash) {
        try {
          const json = atob(location.hash.slice(1));
          data = JSON.parse(json);
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du hash", e);
        }
      }

      // Si aucune donn√©e valide, ne rien faire
      if (!data) return;

      // Remplir le formulaire avec les donn√©es charg√©es
      document.getElementById('date').value = data.d || today;
      document.getElementById('wake').value = data.w || '';
      document.getElementById('dayQuality').value = data.q || '';
      document.getElementById('comment').value = data.c || '';

      bottleList.innerHTML = '';
      (data.bottles || []).forEach(b => {
        addBottle(b.time, b.ml);
      });
      updateBottleTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      diaperList.innerHTML = '';
      (data.diapers || []).forEach(d => {
        addDiaper(d.time, d.poop);
      });

      napList.innerHTML = '';
      (data.naps || []).forEach(n => {
        addNap(n.start, n.end);
      });
      updateNapTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      mealList.innerHTML = '';
      (data.meals || []).forEach(m => {
        addMeal(m.time, m.type, m.weight);
      });
    }

    // Charge les donn√©es depuis le localStorage ou le hash et les ins√®re dans le formulaire
    function loadDataAnotherDay() {
      let data = null;

      // R√©cup√®re la date du jour
      const dateInput = document.getElementById('date');
      const today = dateInput.value || new Date().toISOString().split('T')[0];

      // Priorit√© 1 : Charger depuis le localStorage pour la date du jour
      const storedData = localStorage.getItem(`babyTrackData_${today}`);
      if (storedData) {
        try {
          data = JSON.parse(atob(storedData));
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du localStorage", e);
        }
      }

      // Priorit√© 2 : Charger depuis le hash si aucune donn√©e valide dans le localStorage
      if (!data && location.hash) {
        try {
          const json = atob(location.hash.slice(1));
          data = JSON.parse(json);
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du hash", e);
        }
      }

      // Si aucune donn√©e valide, ne rien faire
      if (!data) return;

      // Remplir le formulaire avec les donn√©es charg√©es
      document.getElementById('date').value = data.d || today;
      document.getElementById('wake').value = data.w || '';
      document.getElementById('dayQuality').value = data.q || '';
      document.getElementById('comment').value = data.c || '';

      bottleList.innerHTML = '';
      (data.bottles || []).forEach(b => {
        addBottle(b.time, b.ml);
      });
      updateBottleTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      diaperList.innerHTML = '';
      (data.diapers || []).forEach(d => {
        addDiaper(d.time, d.poop);
      });

      napList.innerHTML = '';
      (data.naps || []).forEach(n => {
        addNap(n.start, n.end);
      });
      updateNapTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      mealList.innerHTML = '';
      (data.meals || []).forEach(m => {
        addMeal(m.time, m.type, m.weight);
      });
    }

    // Initialise la page en chargeant les donn√©es depuis le localStorage ou le hash
    window.onload = () => {
      const dateInput = document.getElementById('date');
      if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
      loadData();
      updateDaySummary();
    };
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Suivi b√©b√©</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
      min-width: 500px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    h1 {
      text-align: center;
      color: #4CAF50;
      font-size: 24px;
      margin-bottom: 20px;
    }

    .section {
      background-color: #fff;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h3 {
      color: #4CAF50;
      margin-bottom: 10px;
    }

    .entry {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .entry input,
    .entry select,
    .entry button {
      margin-right: 10px;
      /* padding: 5px; */
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    .entry button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .entry button:hover {
      background-color: #45a049;
    }

    .labeltext {
      margin-right: 10px;
    }

    textarea {
      width: 100%;
      height: 80px;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      resize: none;
    }

    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    button:hover {
      background-color: #45a049;
    }

    input[type="time"],
    input[type="date"],
    input[type="number"],
    select {
      width: calc(100% - 20px);
      padding: 8px;
      /* margin-bottom: 10px; */
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    p {
      font-size: 14px;
      color: #666;
    }

    a {
      color: #4CAF50;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .link-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
    }

    .link-container input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px 0 0 5px;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .link-container button {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 0 5px 5px 0;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .link-container button:hover {
      background-color: #45a049;
    }
  </style>
</head>

<body>
  <h1>Suivi b√©b√©<br>Du <input type="date" id="date" onchange="loadDataAnotherDay()"></h1><br>


  <div class="section">
    <h3>Heure de lev√©e : <input type="time" id="wake"></h3><br>
  </div>

  <div class="section">
    <h3>Biberon - Total : <span id="bottle-total">0</span> ml</h3>
    <div id="bottle-list"></div>
    <button onclick="addBottle()">Ajouter un biberon</button>
  </div>

  <div class="section">
    <h3>Changements de couche</h3>
    <div id="diaper-list"></div>
    <button onclick="addDiaper()">Ajouter un change</button>
  </div>

  <div class="section">
    <h3>Siestes - Total : <span id="nap-total">0</span> heures</h3>
    <div id="nap-list"></div>
    <button onclick="addNap()">Ajouter une sieste</button>
  </div>

  <div class="section">
    <h3>Repas solides :</h3>
    <div id="meal-list"></div>
    <button onclick="addMeal()">Ajouter un repas</button>
  </div>

  <div class="section">
    <h3>Qualit√© de la journ√©e</h3>
    <label>
      <select id="dayQuality">
        <option value="">-- S√©lectionner --</option>
        <option value="1">üò£ Difficile</option>
        <option value="2">üòê Moyenne</option>
        <option value="3">üòä Bonne</option>
      </select>
    </label>
  </div>

  <div class="section">
    <h3>Commentaire</h3>
    <textarea id="comment" placeholder="Notes ou remarques..."></textarea>
  </div>

  <div class="section">
    <button onclick="generateLink()">Save/Share</button>
    <div class="link-container">
      <input id="generatedLink" type="text" readonly>
      <button onclick="copyLink()">Copier</button>
    </div>
  </div>

  <!-- <div class="section">
    <h3>R√©sum√© de la journ√©e</h3>
    <p id="day-summary"></p>
  </div> -->

  <script>
    const bottleList = document.getElementById('bottle-list');
    const diaperList = document.getElementById('diaper-list');
    const napList = document.getElementById('nap-list');
    const mealList = document.getElementById('meal-list');


    // Met √† jour le total des biberons
    function updateBottleTotal() {
      const total = Array.from(bottleList.children).reduce((sum, entry) => {
        const mlInput = entry.querySelector('input[type="number"]');
        return sum + (parseInt(mlInput.value) || 0);
      }, 0);
      document.getElementById('bottle-total').textContent = total;
    }


    // Ajoute une entr√©e pour un biberon dans la liste
    function addBottle(time = '', ml = 210) {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `<input type="time" value="${time}">
        <input type="number" min="0" step="30" value="${ml}" style="width: 60px;">
        <span class="labeltext">ml</span>
        <button onclick="this.parentNode.remove()">Suppr</button>`;
      bottleList.appendChild(div);
      updateBottleTotal();
    }

    // Ajoute une entr√©e pour un changement de couche dans la liste
    function addDiaper(time = '', poop = false) {
      const container = document.createElement('div');
      container.className = 'entry';
      container.innerHTML = `
        <input type="time" value="${time}">
        <label><input type="checkbox" ${poop ? 'checked' : ''}> üí©</label>
        <button onclick="this.parentElement.remove()">Suppr</button>`;
      diaperList.appendChild(container);
    }


    // Ajoute une entr√©e pour une sieste dans la liste
    function addNap(start = '', end = '') {
      const container = document.createElement('div');
      container.className = 'entry';
      container.innerHTML = `
        <input type="time" value="${start}" onchange="updateNapTotal()"style="height: 20px;padding: 8px;">
        <span class="labeltext" style="height: 20px;padding: 8px;">-</span> 
        <input type="time" value="${end}" onchange="updateNapTotal()" style="height: 20px;padding: 8px;">
        <button onclick="this.parentElement.remove(); updateNapTotal()">Suppr</button>`;
      napList.appendChild(container);
      updateNapTotal();
    }

    // Met √† jour le total des siestes
    function updateNapTotal() {
      const total = Array.from(napList.children).reduce((sum, entry) => {
        const inputs = entry.querySelectorAll('input[type="time"]');
        const start = inputs[0].value;
        const end = inputs[1].value;

        if (start && end) {
          const startTime = new Date(`1970-01-01T${start}:00`);
          const endTime = new Date(`1970-01-01T${end}:00`);
          const duration = (endTime - startTime) / (1000 * 60 * 60); // Convertir en heures
          return sum + (duration > 0 ? duration : 0); // Ajouter uniquement les dur√©es positives
        }
        return sum;
      }, 0);

      document.getElementById('nap-total').textContent = total.toFixed(2); // Afficher avec 2 d√©cimales
    }

    // Ajoute une entr√©e pour un repas solide dans la liste
    function addMeal(time = '', type = 'pur√©e de ', g = 0) {
      const div = document.createElement('div');
      div.className = 'entry';
      div.innerHTML = `<input type="time" value="${time}" style="width: 80px;">
        <input type="text" placeholder="Type (pur√©e...)" value="${type}"  style="width: calc(100% - 20px);height: 20px;padding: 8px;">
        <input type="number" min="0" step="10" value="${g}" style="width: 60px;height: 20px;">
        <span class="labeltext" style="height: 20px;padding: 8px;">gr.</span>
        <button onclick="this.parentNode.remove()">Suppr</button>`;
      mealList.appendChild(div);
    }

    // Encode les donn√©es saisies dans le formulaire en JSON, puis en base64
    function encodeData() {
      const d = document.getElementById('date').value;
      const w = document.getElementById('wake').value;
      const q = document.getElementById('dayQuality').value;
      const c = document.getElementById('comment').value;

      const bottles = Array.from(bottleList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          time: inputs[0].value,
          ml: inputs[1].value
        };
      });

      const diapers = Array.from(diaperList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          time: inputs[0].value,
          poop: inputs[1].checked
        };
      });

      const naps = Array.from(napList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          start: inputs[0].value,
          end: inputs[1].value
        };
      });

      const meals = Array.from(mealList.children).map(entry => {
        const inputs = entry.querySelectorAll('input');
        return {
          time: inputs[0].value,
          type: inputs[1].value,
          weight: inputs[2].value
        };
      });

      const obj = { d, w, q, c, bottles, diapers, naps, meals };
      return btoa(JSON.stringify(obj));
    }

    // G√©n√®re un lien partageable contenant les donn√©es encod√©es
    function generateLink() {
      const hash = encodeData();
      const url = location.origin + location.pathname + '#' + hash;

      // R√©cup√®re la date du jour
      const date = document.getElementById('date').value;

      // Sauvegarde les donn√©es dans le localStorage avec la date comme cl√©
      if (date) {
        localStorage.setItem(`babyTrackData_${date}`, hash);
      }

      const link = document.getElementById('generatedLink');
      link.value = url;

      // updateDaySummary();
    }

    function copyLink() {
      const link = document.getElementById('generatedLink');
      link.select();
      document.execCommand("copy");
    }

    // D√©code les donn√©es encod√©es en base64 depuis l'URL
    function decodeData() {
      if (!location.hash) return null;
      try {
        const json = atob(location.hash.slice(1));
        return JSON.parse(json);
      } catch (e) {
        console.error("Erreur de d√©codage", e);
        return null;
      }
    }

    // Charge les donn√©es depuis le localStorage ou le hash et les ins√®re dans le formulaire
    function loadData() {
      let data = null;

      // R√©cup√®re la date du jour
      const dateInput = document.getElementById('date');
      const today = dateInput.value || new Date().toISOString().split('T')[0];

      // Priorit√© 1 : Charger depuis le localStorage pour la date du jour
      const storedData = localStorage.getItem(`babyTrackData_${today}`);
      if (storedData) {
        try {
          data = JSON.parse(atob(storedData));
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du localStorage", e);
        }
      }

      // Priorit√© 2 : Charger depuis le hash si aucune donn√©e valide dans le localStorage
      if (!data && location.hash) {
        try {
          const json = atob(location.hash.slice(1));
          data = JSON.parse(json);
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du hash", e);
        }
      }

      // Si aucune donn√©e valide, ne rien faire
      if (!data) return;

      // Remplir le formulaire avec les donn√©es charg√©es
      document.getElementById('date').value = data.d || today;
      document.getElementById('wake').value = data.w || '';
      document.getElementById('dayQuality').value = data.q || '';
      document.getElementById('comment').value = data.c || '';

      bottleList.innerHTML = '';
      (data.bottles || []).forEach(b => {
        addBottle(b.time, b.ml);
      });
      updateBottleTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      diaperList.innerHTML = '';
      (data.diapers || []).forEach(d => {
        addDiaper(d.time, d.poop);
      });

      napList.innerHTML = '';
      (data.naps || []).forEach(n => {
        addNap(n.start, n.end);
      });
      updateNapTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      mealList.innerHTML = '';
      (data.meals || []).forEach(m => {
        addMeal(m.time, m.type, m.weight);
      });
    }

    // Charge les donn√©es depuis le localStorage ou le hash et les ins√®re dans le formulaire
    function loadDataAnotherDay() {
      let data = null;

      // R√©cup√®re la date du jour
      const dateInput = document.getElementById('date');
      const today = dateInput.value || new Date().toISOString().split('T')[0];

      // Priorit√© 1 : Charger depuis le localStorage pour la date du jour
      const storedData = localStorage.getItem(`babyTrackData_${today}`);
      if (storedData) {
        try {
          data = JSON.parse(atob(storedData));
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du localStorage", e);
        }
      }

      // Priorit√© 2 : Charger depuis le hash si aucune donn√©e valide dans le localStorage
      if (!data && location.hash) {
        try {
          const json = atob(location.hash.slice(1));
          data = JSON.parse(json);
        } catch (e) {
          console.error("Erreur de d√©codage des donn√©es du hash", e);
        }
      }

      // Si aucune donn√©e valide, ne rien faire
      if (!data) return;

      // Remplir le formulaire avec les donn√©es charg√©es
      document.getElementById('date').value = data.d || today;
      document.getElementById('wake').value = data.w || '';
      document.getElementById('dayQuality').value = data.q || '';
      document.getElementById('comment').value = data.c || '';

      bottleList.innerHTML = '';
      (data.bottles || []).forEach(b => {
        addBottle(b.time, b.ml);
      });
      updateBottleTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      diaperList.innerHTML = '';
      (data.diapers || []).forEach(d => {
        addDiaper(d.time, d.poop);
      });

      napList.innerHTML = '';
      (data.naps || []).forEach(n => {
        addNap(n.start, n.end);
      });
      updateNapTotal(); // Met √† jour le total apr√®s le chargement des donn√©es

      mealList.innerHTML = '';
      (data.meals || []).forEach(m => {
        addMeal(m.time, m.type, m.weight);
      });
    }

    // Initialise la page en chargeant les donn√©es depuis le localStorage ou le hash
    window.onload = () => {
      const dateInput = document.getElementById('date');
      if (!dateInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
      }
      loadData();
      // updateDaySummary();
    };
  </script>
</body>

</html>